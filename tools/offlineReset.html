<!DOCTYPE html>
<html lang="en-us">
<head>
    <title>Reset Offline Storage</title>
    <meta charset="utf-8" />
    <!-- if search engine keys are desired, 
        use: <meta name="keywords" content="key1, key2, .." -->
    <meta name="description" content="Clear Cache/Worker" />
    <meta name="author" content="Ken Cowles" />
    <meta name="robots" content="nofollow" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>

<div>This page is a tool to clear cache, uninstall the service worker
    and clear the indexedDB and localStorage on a mobile browser.<br />
    Access via https://nmhikes.com/tools/offlineReset.html
</div>

<!-- Not on main site yet [adjust test site for scripts]-->
<script src="../scripts/ktesaOfflineDB.js"></script>
<script type="text/javascript">
    var msg = '';
    async function deleteNamedCache(cacheName) {
        if ('caches' in window) {
            try {
                const wasDeleted = await caches.delete(cacheName);
                if (wasDeleted) {
                    msg += `Cache "${cacheName}" successfully deleted.`
                    console.log(`Cache "${cacheName}" successfully deleted.`);
                } else {
                    msg += `Cache "${cacheName}" not found.`
                    console.log(`Cache "${cacheName}" not found.`);
                }
                return wasDeleted;
            } catch (error) {
                msg += `Error deleting cache "${cacheName}":` + error;
                console.error(`Error deleting cache "${cacheName}":`, error);
                throw error;
            }
        } else {
            console.warn("Cache API not supported in this environment.");
            return false;
        }
    }
    navigator.serviceWorker.getRegistrations()
    .then( async function(registrations) { 
        var i = 0;
        for(let registration of registrations) {
            i++;
            // This code won't execute when there are no registrations
            if (i === 1) { // In case of multiple service_workers 
                await registration.unregister();
                if (typeof msg !== 'undefined') {
                    msg += "Unregistered service worker\n";
                }
                await deleteNamedCache("offline");
                var status = await clearObjectStore();
                if (status === 'cleared') {
                    msg += "\nIndexedDB data cleared";
                } else {
                    msg += "\nThere was an error clearing the indexed " 
                        + "db: " + status;
                }
            }
        }
        var allmaps = localStorage.getItem('mapnames');
        if (allmaps !== null) {
            var maplist = allmaps.split(",");
            if (maplist.length > 0 && maplist[0] !== "none") {
                for (let k=0; k<maplist.length; k++) {
                    localStorage.removeItem(maplist[k]);
                    msg += "\nRemoved " + maplist[k];
                }
            }
            localStorage.removeItem('mapnames');
            msg += "\nMapnames removed";
        }
        alert(msg);
    });
</script>

</body>
</html>