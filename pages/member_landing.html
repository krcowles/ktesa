<!DOCTYPE html>
<html lang="en-us">
<head>
<title>New Mexico Hikes</title>
    <meta charset="utf-8" />
    <meta name="description" content="Mobile site for New Mexico Hikes" />
    <meta name="author" content="Ken Cowles" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link href="../styles/bootstrap.min.css" rel="stylesheet" />
    <link href="../styles/landing.css" type="text/css" rel="stylesheet" />
    <script src="../scripts/jquery.js"></script>
</head>

<body>
<!-- Admin: Sets new version when it's time for a software update! -->
<span style="display:none;" id="version">1</span>

<div id="logo">
    <div id="pattern">
    </div>
    <div id="pgheader">
        <div id="leftside">
            <img id="hikers" src="../images/hikers.png" alt="hikers icon" />
            <span id="logo_left">Hike</span>
        </div>
        
        <!-- minimal functionality "navbar" -->
        <div id="ctr">
            <select id="membership">
                <option id="sao"    value="sao">Member Options:</option>
                <option id="login"  value="login">Login          </option>
                <option id="logout" value="logout">Logout        </option>
                <option id="bam"    value="bam">Become a member  </option>>      
            </select>
        </div>

        <div id="rightside">
            <img id="tmap" src="../images/trail.png" alt="trail map icon" />
            <span id="logo_right">w/Tom &amp; Ken</span>
        </div>
    </div>   
</div>
<p id="cookie_state">OK</p>

<dialog id="update">
    <p>A software upgrade has successfully completed</p><br />
    <button id="ok" type="button" class="btn btn-sm btn-success">OK</button><br /><br />
</dialog> 
<dialog id="noupdate">
    <div id="errormail">A software upgrade did not complete.<br />
        We apologize, but automated email cannot be guaranteed. Please email 
        <span id="adminmail"></span> and attach the following
        message, along with your username: we will work to resolve
        this issue:<br />
        <span id="adminmsg"></span><br /><br />Thank you!
    </div><br />
    <button id="notok" type="button" class="btn btn-sm btn-success">Close</button><br /><br />
</dialog> 



<h2 id="welcome">The New Mexico Hiking Site</h2>
<div class="landing_content">
    <p id="opts">Choose from the following
        <span id="vopts"> viewing options:</span></p>

    <div class="usr_choices">
        <div class="flexitem">
                <div class="pair" id="choice1">
                    <p id="tbldesc">Hike Table</p>
                    <img id="table" class="icons" src="../images/Tbl.png" 
                        alt="image of table of hikes" />
                </div>
                <div class="pair" id="choice2">
                    <p id="home">Map &amp; markers</p>
                    <img id="map" class="icons" src="../images/MapsNmrkrs.png"
                        alt="map with markers" />
                </div>
                <div class="pair" id="choice3">
                    <p class="dbl">Members:<br />Online Save</p>
                    <img id="save" class="icons" src="../images/Save.png"
                        alt="offlinemap icon" />
                </div>
                    <div class="pair" id="choice4">
                    <p class="dbl">Members:<br/>Use Offline</p>
                    <img id="use" class="icons" src="../images/Use.png"
                        alt="offlinemap icon" />
                </div>
        </div>
    </div>
    <div id="bennies">
        Membership is free!<br />Benefits include :
        <ul id="memlist">
            <li>Save/Display Favorites</li>
            <li>Create/Edit hike pages<br /><em>[Laptops/desktops only]</em></li>
            <li>Offline maps</li>
        </ul>
    </div>
</div>

<script src="../scripts/bootstrap.min.js"></script>
<script src="../scripts/ktesaOfflineDB.js"></script>
<script src="../scripts/loginState.js"></script>
<script src="../scripts/viewMgr.js"></script>
<script src="../scripts/cacheDeleteFct.js"></script>
<script src="../scripts/landing.js"></script>

<script type="text/javascript">
    // only members will be on this page
    const CACHE_NAMES = {
        tiles: 'map_tiles',
        code: 'map_source'
    };
    // dialog box operation
    const update_success = document.getElementById('update');
    const update_failure = document.getElementById('noupdate');
    $('#ok').on("click", () => {
        update_success.close();
    });
    $('#notok').on("click", () => {
        update_failure.close();
    });
    // failure vars
    const sendEmail = document.getElementById('adminmail');
    const sendEmsg  = document.getElementById('adminmsg');
    const encodedEmail = "a3Jjb3dsZXMyOUBnbWFpbC5jb20="; 
    const adminEmail = atob(encodedEmail);
    
    console.log("Begin checking for updates...");
    
    // routines called during software update process
    function sw_update() {
        return new Promise((resolve) => { 
            var errors = '';
            var proceed = $.Deferred();
            console.log("sw_update started");
            navigator.serviceWorker.getRegistrations()
            .then( async function(registrations) { 
                // the existence of registration was already verified
                // in the calling routine
                var i = 0;
                console.log("Start unregister loop");
                for(let registration of registrations) {
                    i++;
                    if (i === 1) { // In case of multiple service_workers 
                        var unreg = await registration.unregister();
                        if (!unreg) {
                            errors += "Service worker not unregistered";
                        }
                    }
                }
                console.log("finished unregister");
                proceed.resolve()
            });
            $.when(proceed).then( async () => {
                var status = await deleteNamedCache(CACHE_NAMES.code);
                errors += status;
                console.log("cache deleted; errors: ", errors);
                resolve(errors);
            });
        },
        (reject) => {
            console.log("Promise in sw_update did not resolve");
            update_failure.showModal();
        });
    }
    async function install_service_worker() {
        console.log("Start install");
        try {
            const registration = await navigator.serviceWorker
            // for localhost, scope: "/"; server, scope "nmhikes.com/""
            .register("/service_worker.js", {scope: "/"})
            .then((reg) => {
                if (reg.installing) {
                    console.log("Service worker installing");
                } else if (reg.waiting) {
                    console.log("Service worker installed");
                } else if (reg.active) {
                    console.log("Service worker active");
                }
                reg.addEventListener('updatefound', () => {
                    // An updated service worker while reg.installing
                    console.log("registration in process");
                    const newWorker = reg.installing;
                    switch (newWorker.state) {
                    case "installed":
                        console.log("Updated worker installed");
                        break;
                    case "activated":
                        console.log("Updated worker active");
                        break;
                    case "redundant":
                        console.log("Discarded: failed to install");
                    }
                });
            });        
        } catch (error) {
                console.error(`Registration failed with ${error}`);
                udate_failure.showModal();
        }
    }
    /**
     * Check to see if a service worker is already registered.
     * If not registered, skip the upgrade and proceed to install
     * the service worker, as in this case, the member has never
     * visited the mobile site before now and the new code will
     * load 'from scratch'. If registered, AND the stored version
     * doesn't match the current stated html version, then perform
     * the upgrade.
     */
    update = false;
    var sw_version = $('#version').text(); // string
    var memberMapnames = localStorage.getItem('mapnames');
    /**
     * Due to multiple previous code versions, the state of
     * mapnames is uncertain. If it doesn't exist, set it.
     * If it does exist, it will remain untouched.
     */
    if (memberMapnames === null) {
        console.log("mapnames was not set");
        localStorage.setItem('mapnames', 'none');
    } else {
        console.log("mapnames: ", memberMapnames);
    }
    var saved_ver = localStorage.getItem('saved_ver');
    if (saved_ver === null) {
        console.log("saved_ver null");
    } else {
        console.log("saved_ver on entry: ", saved_ver);
    }
    // Has a worker been registered?
    navigator.serviceWorker.getRegistration()
    .then(registration => {
        if (registration) {
            if (saved_ver === null) {
                update = true;
                console.log("update forced by saved_ver null");
            } else {
                if (saved_ver !== sw_version) {
                    update = true;
                    console.log("update forced by mismatch ver");
                }
            } // otherwise, no update
            if (update) {
                console.log("update initiated");
                sw_update()
                .then( async (errs) => {
                    console.log("errs: ", errs)
                    if (errs === '') {
                        console.log("no errors after update");
                        await install_service_worker();
                        localStorage.setItem('saved_ver', sw_version);
                        console.log("New saved_ver: ", sw_version);
                        update_success.showModal();
                    } else {
                        console.log("Errors: ", errs);
                        sendEmail.textContent = adminEmail;
                        sendEmsg.textContent = errs;
                        console.log("New saved_ver not set");
                        update_failure.showModal();
                    }
                });
            }
        }  else {
            // not registered? no update, no update message
            console.log("Not registered");
            localStorage.setItem('saved_ver', sw_version);
            install_service_worker();
        }
    });
</script>

</body>
</html>
